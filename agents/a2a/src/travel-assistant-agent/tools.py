"""Tools for Travel Assistant Agent - Flight search and trip planning utilities."""

import json
import logging
from typing import (
    Any,
    Dict,
    List,
    Optional,
)

from strands import tool

from dependencies import get_db_manager

# Configure logging with basicConfig
logging.basicConfig(
    level=logging.INFO,  # Set the log level to INFO
    # Define log message format
    format="%(asctime)s,p%(process)s,{%(filename)s:%(lineno)d},%(levelname)s,%(message)s",
)
logger = logging.getLogger(__name__)


@tool
def search_flights(
    departure_city: str,
    arrival_city: str,
    departure_date: str,
) -> str:
    """Search for available flights between cities on a specific date."""
    logger.info(
        f"Tool called: search_flights(departure_city={departure_city}, arrival_city={arrival_city}, departure_date={departure_date})"
    )
    try:
        flights = get_db_manager().search_flights(departure_city, arrival_city, departure_date)

        result = {
            "query": {"departure_city": departure_city, "arrival_city": arrival_city, "departure_date": departure_date},
            "flights": flights,
            "count": len(flights),
        }

        logger.debug(f"Flight search result:\n{json.dumps(result, indent=2)}")
        return json.dumps(result, indent=2)

    except Exception as e:
        logger.error(f"Database error in search_flights: {e}")
        return json.dumps({"error": f"Database error: {str(e)}"})


@tool
def check_prices(
    flight_id: int,
) -> str:
    """Get pricing and seat availability for a specific flight."""
    logger.info(f"Tool called: check_prices(flight_id={flight_id})")
    try:
        flight_details = get_db_manager().get_flight_details(flight_id)

        if not flight_details:
            error_msg = f"Flight with ID {flight_id} not found"
            logger.warning(error_msg)
            return json.dumps({"error": error_msg})

        logger.debug(f"Flight details result:\n{json.dumps(flight_details, indent=2)}")
        return json.dumps(flight_details, indent=2)

    except Exception as e:
        logger.error(f"Database error in check_prices: {e}")
        return json.dumps({"error": f"Database error: {str(e)}"})


@tool
def get_recommendations(
    max_price: float,
    preferred_airlines: Optional[List[str]] = None,
) -> str:
    """Get flight recommendations based on customer preferences."""
    logger.info(f"Tool called: get_recommendations(max_price={max_price}, preferred_airlines={preferred_airlines})")
    try:
        recommendations = get_db_manager().get_recommendations(max_price, preferred_airlines)

        result = {
            "criteria": {"max_price": max_price, "preferred_airlines": preferred_airlines or "Any"},
            "recommendations": recommendations,
            "count": len(recommendations),
        }

        logger.debug(f"Recommendations result:\n{json.dumps(result, indent=2)}")
        return json.dumps(result, indent=2)

    except Exception as e:
        logger.error(f"Database error in get_recommendations: {e}")
        return json.dumps({"error": f"Database error: {str(e)}"})


@tool
def create_trip_plan(
    departure_city: str,
    arrival_city: str,
    departure_date: str,
    return_date: Optional[str] = None,
    budget: Optional[float] = None,
) -> str:
    """Create and save a trip planning record."""
    logger.info(
        f"Tool called: create_trip_plan(departure_city={departure_city}, arrival_city={arrival_city}, departure_date={departure_date})"
    )
    logger.debug(f"Return date: {return_date}, Budget: {budget}")
    try:
        db_manager = get_db_manager()
        trip_plan_id = db_manager.create_trip_plan(departure_city, arrival_city, departure_date, return_date, budget)

        # Get available flights for the trip
        outbound_flights = db_manager.search_flights(departure_city, arrival_city, departure_date)
        return_flights = []

        if return_date:
            return_flights = db_manager.search_flights(arrival_city, departure_city, return_date)

        result = {
            "trip_plan_id": trip_plan_id,
            "trip_details": {
                "departure_city": departure_city.upper(),
                "arrival_city": arrival_city.upper(),
                "departure_date": departure_date,
                "return_date": return_date,
                "budget": budget,
                "status": "planning",
            },
            "outbound_flights": outbound_flights,
            "return_flights": return_flights,
            "next_steps": ["Review available flights", "Select preferred flights", "Contact Flight Booking Agent for reservation"],
        }

        logger.debug(f"Trip plan result:\n{json.dumps(result, indent=2)}")
        return json.dumps(result, indent=2)

    except Exception as e:
        logger.error(f"Database error in create_trip_plan: {e}")
        return json.dumps({"error": f"Database error: {str(e)}"})


@tool
async def invoke_discovered_agent(
    agent_name: str,
    skill_id: str,
    parameters: Dict[str, Any],
) -> str:
    """Invoke a skill on a discovered agent.

    First use discover_agents to find available agents, then use this tool
    to invoke one of their skills. This enables multi-agent collaboration.

    Args:
        agent_name: Name of the agent (from discover_agents result)
        skill_id: Skill ID to invoke (from agent's skills list)
        parameters: Dictionary of parameters required by the skill

    Returns:
        JSON string with skill execution result

    Example:
        # First discover agents
        agents = discover_agents("agent that can book flights")
        # Then invoke a skill
        result = invoke_discovered_agent(
            agent_name="Flight Booking Agent",
            skill_id="reserve_flight",
            parameters={"flight_id": 123, "passenger_name": "John Doe"}
        )
    """
    logger.info(f"Tool called: invoke_discovered_agent(agent_name={agent_name}, skill_id={skill_id})")

    try:
        from dependencies import get_registry_client
        from a2a_tool_factory import invoke_agent_skill

        registry_client = get_registry_client()
        if not registry_client:
            return json.dumps(
                {
                    "error": "Registry discovery not configured",
                    "message": "Set M2M_CLIENT_ID and M2M_CLIENT_SECRET environment variables",
                }
            )

        # First, discover the agent by name
        logger.debug(f"Discovering agent: {agent_name}")
        discovered = await registry_client.discover_by_semantic_search(
            query=agent_name,
            max_results=1,
        )

        if not discovered:
            return json.dumps(
                {
                    "error": "Agent not found",
                    "message": f"No agent found matching '{agent_name}'",
                }
            )

        agent = discovered[0]
        logger.info(f"Found agent: {agent.name} at {agent.url}")

        # Get auth token for invocation
        token = await registry_client._get_token()

        # Invoke the skill
        result = await invoke_agent_skill(
            agent=agent,
            skill_id=skill_id,
            parameters=parameters,
            auth_token=token,
        )

        logger.info(f"Agent skill invocation successful")
        return json.dumps(result, indent=2)

    except Exception as e:
        logger.error(f"Agent invocation error: {e}", exc_info=True)
        return json.dumps(
            {
                "error": "Invocation failed",
                "message": str(e),
            }
        )


@tool
async def discover_agents(query: str) -> str:
    """Discover other agents in the registry by natural language query.

    Use this tool to find agents that can help with tasks beyond your capabilities.
    For example, if you need to book a flight, search for 'agent that can book flights'.

    Args:
        query: Natural language search query describing needed capabilities

    Returns:
        JSON string with discovered agents and their skills
    """
    logger.info(f"Tool called: discover_agents(query='{query}')")

    try:
        from dependencies import get_registry_client

        registry_client = get_registry_client()
        if not registry_client:
            return json.dumps(
                {
                    "error": "Registry discovery not configured",
                    "message": "Set M2M_CLIENT_ID and M2M_CLIENT_SECRET environment variables",
                }
            )

        discovered = await registry_client.discover_by_semantic_search(
            query=query,
            max_results=5,
        )

        result = {
            "query": query,
            "agents_found": len(discovered),
            "agents": [
                {
                    "name": agent.name,
                    "description": agent.description,
                    "path": agent.path,
                    "url": agent.url,
                    "skills": agent.skills,
                    "tags": agent.tags,
                    "relevance_score": agent.score,
                    "trust_level": agent.trust_level,
                }
                for agent in discovered
            ],
        }

        logger.info(f"Discovery successful: found {len(discovered)} agents")
        logger.debug(f"Discovery result:\n{json.dumps(result, indent=2)}")
        return json.dumps(result, indent=2)

    except Exception as e:
        logger.error(f"Discovery error in discover_agents: {e}", exc_info=True)
        return json.dumps(
            {
                "error": "Discovery failed",
                "message": str(e),
            }
        )


TRAVEL_ASSISTANT_TOOLS = [
    search_flights,
    check_prices,
    get_recommendations,
    create_trip_plan,
    discover_agents,
    invoke_discovered_agent,
]